---
title: "MAS 627 - Programming for Data Analytics Shiny App Project"
author: "Dania Maciel, Jean Carlo Betances Garcia, & Philip Bachas-Daunert"
date: "Due: 2023-10-09"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(shiny)
library(tidyverse)
library(leaflet)
library(scales)
library(dplyr)
library(htmltools)
library(htmlwidgets)
library(DT)
library(plotly)
```

# **Brief Overview of the App**

-   Our [Shiny
    App](https://shiny.posit.co/r/getstarted/shiny-basics/lesson1/index.html)
    uses the below data to create an interactive
    [leaflet](https://rstudio.github.io/leaflet/) map of Miami-Dade
    County and all of its parks.

    | Hub Website                                                               | Data Website                                                                                                                     | **Rows of Data** | **Short Description**                                                                                         |
    |--------------|------------------------|----------------|--------------------|
    | [Miami-Dade County's Open Data Hub](https://gis-mdc.opendata.arcgis.com/) | [Park Facility](https://gis-mdc.opendata.arcgis.com/datasets/MDC::park-facility/explore?location=25.669379%2C-80.308500%2C11.56) | 826              | A point feature class of all park facilities (County, Municipal, State or National) within Miami-Dade County. |

# **The "Why" for this App**

-   Miami experienced the largest increase in people moving in from
    before the pandemic.
    -   We saw gains of nearly 60% in 2022 compared with 2019, per a new
        report from the National Association of Realtors.

    -   [Axios: More people are moving to
        Miami](https://www.axios.com/local/miami/2023/02/07/miami-migration-moving-pandemic)
-   We designed this App in mind that many people are moving to Miami to
    enjoy the constant sunshine.
-   We want to further sell the outdoor activities to newcomers by
    illustration the location of parks in Miami-Dade County with major
    outdoor activity facilities.

# **Key Features**

-   Below has a table of major outdoor activity facilities the App
    highlights in Miami-Dade County.

-   Discover Different activities throughout florida parks

-   Municipal Park Facilities by City.

-   List of Dog Park Locations

-   Count of Total Camping Sites

| Variable    | Yes | No  | NaN |
|-------------|-----|-----|-----|
| BASEBALL    | 79  | 683 | 64  |
| BASKETBALL  | 112 | 653 | 61  |
| BEACH       | 23  | 738 | 65  |
| FITNESSZONE | 28  | 755 | 43  |
| FOOTBALL    | 37  | 723 | 66  |
| NATURETRAI  | 29  | 735 | 62  |
| RAQUETBALL  | 21  | 740 | 65  |
| SOCCER      | 52  | 711 | 63  |
| SWIMMING    | 42  | 719 | 65  |
| TENNIS      | 63  | 701 | 62  |
| TRAIL       | 174 | 595 | 57  |
| VOLLEYBALL  | 26  | 736 | 64  |

# **Challenges in this App?**

-   Constant debugging with Shiny App.
    -   We add one feature, then it causes a previously added feature to
        break.
-   Getting the clusters to work.
-   Getting custom icons to work for each sports activity.
-   Not being able to work out the bugs of all the features we wanted
    before the deadline.

```{r include=FALSE}
# Load the dataset
parks <- read.csv('Park_Facility.csv')

# Define a function to replace blanks with "No" for specific columns
replace_blanks <- function(df) {
  # Define the columns to process
  columns_to_process <- c(
    "AMPHITHEAT", "ARCHERY", "ART", "AUDITORIUM", "BASEBALL", "BASKETBALL",
    "BEACH", "BIKETRAIL", "BMXTRACK", "BOATRAMP", "CAMPGROUND", "CANOE_LAUNCH",
    "DOGPARK", "EQUESTRIAN", "FITNESSZONE", "FOOTBALL", "FRISBEEGOL", "GOLF",
    "GOLFDRIVIN", "GUNRANGE", "GYMNASIUM", "MARINA", "MOUNTAINBI", "NATURECENT",
    "NATURETRAI", "PLAYGROUND", "RAQUETBALL", "REC_CENTER", "RESTROOM", 
    "ROLLERHOCK", "RVCAMPGROU", "SHELTER", "SKATING", "SOCCER", "STADIUM", 
    "SWIMMING", "TENNIS", "TOTLOT", "TRACK400", "TRAIL", "VOLLEYBALL", 
    "WETPLAYGRO", "WIFI", "ZOO", "FIT2PLAY", "LRN2SWIM", "SPRCAMP", "SUMCAMP", 
    "AFTSCHCAMP", "ACTOLDADLPRG", "WINTCAMP", "ONEDAYCAMP"
  )
  
  # Loop through each column and replace blank entries with "No"
  for (col in columns_to_process) {
    df[[col]] <- ifelse(df[[col]] == "", "No", df[[col]])
  }
  return(df)
}

# Apply the function to the parks data
parks <- replace_blanks(parks)

# Replace missing values for various columns
parks$CITY <- ifelse(parks$CITY == "", "Unknown", parks$CITY)
parks$ZIPCODE <- ifelse(parks$ZIPCODE == "" | parks$ZIPCODE == "0", "Unknown", parks$ZIPCODE)
parks$PHONE <- ifelse(parks$PHONE == "", "Unknown", parks$PHONE)
parks$TOTACRE <- ifelse(parks$TOTACRE == "" | as.numeric(parks$TOTACRE) < 1, "0", parks$TOTACRE)
parks$LAT <- ifelse(parks$LAT == "" | parks$LAT == "0", "Unknown", parks$LAT)
parks$LON <- ifelse(parks$LON == "" | parks$LON == "0", "Unknown", parks$LON)
parks$CLASS <- ifelse(parks$CLASS == "", "Unknown", parks$CLASS)
parks$TYPE <- ifelse(parks$TYPE == "", "Unknown", parks$TYPE)
parks$MNGTAGCY <- ifelse(parks$MNGTAGCY == "", "Unknown", parks$MNGTAGCY)
parks$FACILITYPLAN <- ifelse(parks$FACILITYPLAN == "", "Unknown", parks$FACILITYPLAN)

# Provide a default URL for parks without a specific URL
parks$PARKURL <- ifelse(parks$PARKURL == "", "http://www.miamidade.gov/parks/", parks$PARKURL)

# Define columns related to sports activities
columns_to_check <- c("ARCHERY", "BASEBALL", "BASKETBALL", "FOOTBALL", "FRISBEEGOL", 
                      "GOLF", "GOLFDRIVIN", "GUNRANGE", "RAQUETBALL", "SKATING", 
                      "SOCCER", "SWIMMING", "TENNIS", "VOLLEYBALL")

# Create a new binary column indicating the availability of sports facilities
parks$Sports <- ifelse(rowSums(parks[columns_to_check] == "Yes") > 0, "Yes", "No")

# Define columns related to camping
camp_columns <- c("CAMPGROUND", "RVCAMPGROU", "SPRCAMP", "SUMCAMP", 
                  "AFTSCHCAMP", "WINTCAMP", "ONEDAYCAMP")

# Create a new binary column indicating the availability of camping facilities
parks$CAMPING <- ifelse(rowSums(parks[camp_columns] == "Yes") > 0, "Yes", "No")
```

```{r include=FALSE}
# Print the number of unique values for various park attributes
cat('Unique values in parks$CLASS:', length(unique(parks$CLASS)), '\n')
cat('Unique values in parks$TYPE:', length(unique(parks$TYPE)), '\n')
cat('Unique values in parks$MUNICIPAL_:', length(unique(parks$MUNICIPAL_)), '\n')
cat('Unique values in parks$PARKURL:', length(unique(parks$PARKURL)), '\n')
cat('Unique values in parks$MNGTAGCY:', length(unique(parks$MNGTAGCY)), '\n')

# Using dplyr functions to summarize activity counts and reshape the data
act_counts <- parks %>%
  # Summarize the data for each activity, counting 'yes', 'no', and 'NA' responses
  summarise(
    across(AMPHITHEAT:ONEDAYCAMP, 
           list(yes = ~sum(.x == 1, na.rm = TRUE),
                no = ~sum(.x == 0, na.rm = TRUE),
                nan = ~sum(is.na(.x))),
           .names = "{col}_{fn}")
  ) %>%
  # Reshape data: converting wide data to long format
  pivot_longer(everything(), names_to = c("variable", "condition"), 
               names_pattern = "([^_]+)_(.*)") %>%
  # Spread the 'condition' values ('yes', 'no', 'nan') into separate columns
  pivot_wider(names_from = condition, values_from = value) %>%
  # Filter the data to retain only rows with more than 20 'yes' responses
  filter(yes > 20) %>%
  # Remove certain unwanted columns from the data
  select(-c(LAUNCH_yes, LAUNCH_no, LAUNCH_nan, 
            CENTER_yes, CENTER_no, CENTER_nan))

# Print the summarized and reshaped data
print(act_counts)
```

```{r}
basketballIcon <- makeIcon(
  iconUrl = 'https://cdn.pixabay.com/photo/2013/07/13/09/46/basketball-155997_1280.png',
  iconWidth = 20, 
  iconHeight = 25
)

soccerIcon <- makeIcon(
  iconUrl = 'https://cdn.pixabay.com/photo/2013/07/13/10/51/football-157930_1280.png',
  iconWidth = 20, 
  iconHeight = 25
)

unknownIcon <- makeIcon(
  iconUrl = 'https://media.istockphoto.com/id/1251444269/vector/picnic-01.jpg?s=612x612&w=0&k=20&c=zyvUEYgyxjsEZp-dQjA-yAxshjYPiP2v0twF1S1GBV0=',
  iconWidth = 9, 
  iconHeight = 14
)
mymap <- leaflet() %>%
  addTiles() %>%
  setView(lng = -80.3, lat = 25.8, zoom = 12)  # Set the initial view to Miami area
for (i in 1:nrow(parks)) {
  if (parks$BASKETBALL[i] == "Yes") {
    mymap <- mymap %>% addMarkers(
      lng = parks$X[i], 
      lat = parks$Y[i], 
      icon = basketballIcon,
      popup = parks$NAME[i]
    )
  } else if (parks$SOCCER[i] == "Yes") {
    mymap <- mymap %>% addMarkers(
      lng = parks$X[i], 
      lat = parks$Y[i], 
      icon = soccerIcon,
      popup = parks$NAME[i]
    )
  } else {
    mymap <- mymap %>% addMarkers(
      lng = parks$X[i], 
      lat = parks$Y[i], 
      icon = unknownIcon,
      popup = parks$NAME[i]
    )
  }
}
#parks$my_icon = ifelse( park$basketball == 'Yes', basketballIcon, ifelse(park$soccer == 'Yes', soccerIcon, unknownIcon))
#parks %>% leaflet() %>% addMarkers( lng=~X, lat=~Y, icon=~my_icon, popup=~my_popup)
#parks$my_popup = â€¦.
#parks %>% filter(wifi == input$wifi) %>% leaflet()
mymap
```

```{r}
parks = read.csv('Park_Facility.csv')

basketballIcon <- makeIcon(
  iconUrl = 'https://cdn.pixabay.com/photo/2013/07/13/09/46/basketball-155997_1280.png',
  iconWidth = 20, 
  iconHeight = 25
)

soccerIcon <- makeIcon(
  iconUrl = 'https://cdn.pixabay.com/photo/2013/07/13/10/51/football-157930_1280.png',
  iconWidth = 20, 
  iconHeight = 25
)

unknownIcon <- makeIcon(
  iconUrl = 'https://media.istockphoto.com/id/1251444269/vector/picnic-01.jpg?s=612x612&w=0&k=20&c=zyvUEYgyxjsEZp-dQjA-yAxshjYPiP2v0twF1S1GBV0=',
  iconWidth = 20, 
  iconHeight = 25
)

ui <- fluidPage(
  titlePanel("Park Facilities and Sports"),
  
  sidebarLayout(
    sidebarPanel(
      selectizeInput("sport_select", "Select Sport(s):", 
                     choices = c("All", c("ARCHERY", "BASEBALL", "BASKETBALL", "FOOTBALL", "FRISBEEGOL", "GOLF", "GOLFDRIVIN", "GUNRANGE", "RAQUETBALL", "SKATING", "SOCCER", "SWIMMING", "TENNIS", "VOLLEYBALL")),
                     multiple = TRUE, selected = "All"),
      selectInput("dog_park_filter", "Dog Park:", choices = c("All", "Yes", "No")),
      width = 3
    ),
    
    mainPanel(
      tabsetPanel(
        tabPanel("Municipal Park by City", plotlyOutput("municipal_graph")),
        tabPanel("Sports Activity Map", leafletOutput("park_map")),
        tabPanel("Park Facilities", DTOutput("sport_table")),
        tabPanel("Dog Park locations", uiOutput("mngtagcy_list")),
        tabPanel("Total Camping Sites", plotlyOutput("camping_counts"))
      )
    )
  )
)

server <- function(input, output) {
  
  filtered_data <- reactive({
    if("All" %in% input$sport_select) {
      return(parks)
    } else {
      return(parks[apply(parks[input$sport_select] == "Yes", 1, any), ])
    }
  })
  
  filtered_mngtagcy <- reactive({
    df <- filtered_data()
    if (input$dog_park_filter == "All") {
      return(df$NAME)
    } else if (input$dog_park_filter == "Yes") {
      return(df[df$DOGPARK == "Yes", ]$NAME)
    } else {
      return(df[df$DOGPARK == "No", ]$NAME)
    }
  })
  
  output$sport_table <- renderDT({
    datatable(filtered_data()[c("NAME", "ADDRESS", "CITY", "ZIPCODE", "CLASS")], options = list(pageLength = 10))
  })
  
  output$municipal_graph <- renderPlotly({
    df <- parks[parks$MUNICIPAL_ == "Municipal", ]
    city_counts <- table(df$CITY)
    city_counts <- data.frame(CITY = names(city_counts), Count = as.numeric(city_counts))
    
    gg <- ggplot(city_counts, aes(x = CITY, y = Count)) +
      geom_bar(stat = "identity", fill = "#005030") +
      labs(x = "City", y = "Count", title = "Municipal Park Facilities by City") +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
    
    ggplotly(gg)
  })
  
  output$mngtagcy_list <- renderUI({
    mngtagcy_values <- filtered_mngtagcy()
    if (length(mngtagcy_values) > 0) {
      tags$ul(
        lapply(mngtagcy_values, function(val) {
          tags$li(val)
        })
      )
    } else {
      HTML("<p>No matching MNGTAGCY values found.</p>")
    }
  })
  
  output$camping_counts <- renderPlotly({
    df <- filtered_data()
    camping_columns <- c("CAMPGROUND", "RVCAMPGROU", "SPRCAMP", "SUMCAMP", "AFTSCHCAMP", "WINTCAMP", "ONEDAYCAMP")
    counts <- sapply(camping_columns, function(col) sum(df[[col]] == "Yes"))
    
    gg <- ggplot(data.frame(Camping_Column = camping_columns, Count = counts), aes(x = Camping_Column, y = Count)) +
      geom_bar(stat = "identity", fill = "#F47321") +
      labs(x = "Camping Type", y = "Count", title = "Total Camping Locations") +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
    
    ggplotly(gg)
  })
  
  output$park_map <- renderLeaflet({
    mymap <- leaflet() %>%
      addTiles() %>%
      setView(lng = -80.3, lat = 25.8, zoom = 10)  
    for (i in 1:nrow(parks)) {
      if (parks$BASKETBALL[i] == "Yes") {
        mymap <- mymap %>% addMarkers(
          lng = parks$X[i], 
          lat = parks$Y[i], 
          icon = basketballIcon,
          popup = parks$NAME[i]
        )
      } else if (parks$SOCCER[i] == "Yes") {
        mymap <- mymap %>% addMarkers(
          lng = parks$X[i], 
          lat = parks$Y[i], 
          icon = soccerIcon,
          popup = parks$NAME[i]
        )
      } else {
        mymap <- mymap %>% addMarkers(
          lng = parks$X[i], 
          lat = parks$Y[i], 
          icon = unknownIcon,
          popup = parks$NAME[i]
        )
      }
    }
    mymap
  })
}

shinyApp(ui = ui, server = server)
```
